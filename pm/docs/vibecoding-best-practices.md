# Best practices для вайбкодинга с мультиагентами (Gemini CLI, Codex, Claude Code, Cursor)

> Этот документ — reference/чеклист. Операционный процесс см. в `pm/docs/dev-workflow.md`.

## 1) Базовый протокол мультиагентной разработки

### 1.1. Всегда начинать с короткого контракта (1–2 страницы)
Артефакт: `SPEC.md` или `ADR.md` + чек‑лист **Definition of Done**.

Включить:
- цель фичи и не‑цели
- публичные интерфейсы (API/props), форматы ошибок
- edge cases
- как проверяем (команды тестов/линтеров/сборки)
- риски: секреты, миграции, безопасность, обратная совместимость

### 1.2. Резать задачу на тонкие «слайсы»
Агенты лучше всего работают, когда:
- дифф маленький
- есть чёткая команда проверки
- есть стоп‑пойнты: «после каждого шага покажи что изменил и как проверил»

### 1.3. Принудительное разделение ролей
Минимальный набор ролей:
- **Архитектор/планировщик**: предлагает варианты, выбирает подход, пишет план
- **Исполнитель**: вносит изменения в код
- **Ревьюер/QA**: ищет баги/риски, проверяет тест‑кейсы, стиль, безопасность
- (опционально) **Документатор**: README, миграционные заметки, changelog

Не смешивать роли в одном потоке: иначе растёт вероятность ошибок и «подгонки» под ответ.

### 1.4. Цикл «План → Код → Проверка» обязателен
Универсальная формула промпта:
1. «Сначала предложи план из 5–10 шагов»
2. «Пиши код строго по шагам, маленькими порциями»
3. «После каждого шага: что изменил + как проверил»
4. «Если не можешь проверить — скажи, что нужно для проверки»

### 1.5. Память проекта хранить в репозитории
Сделать файл с правилами для агентов:
- `AGENTS.md` (инструкции, конвенции, команды проверки, запреты)
- `GEMINI.md` (инструкции для Gemini CLI)
- `CONTRIBUTING.md` / `ARCHITECTURE.md` (общие правила)

### 1.6. Безопасность: минимальные права + песочница
- не давать агентам доступ к секретам по умолчанию
- работать в изолированном окружении (docker/devcontainer)
- включить pre-commit и CI как «источник правды»
- аккуратно с MCP: подключать только доверенные сервера

---

## 2) За что лучше «назначать» каждую систему

### 2.1. Быстрое правило
- **Cursor** — IDE‑first «ручной штурвал»: фронт, UI, точечные правки, быстрые итерации.
- **Claude Code** — «тяжёлая инженерка»: понимание кодовой базы, большие рефакторы, дебаг, тесты, терминальные прогоны.
- **Codex CLI** — «воспроизводимая агентность»: чёткие шаги + команды проверки + аккуратный цикл agent loop.
- **Gemini CLI** — «поиск/интеграции/триаж»: внешние доки/ошибки, PR review/issue triage, GitHub Actions, MCP.

---

## 3) Таблица: задача → лучший инструмент → почему

| Задача | Лучше всего | Почему |
| --- | --- | --- |
| Быстро набросать/переделать React‑компонент, стили, мелкие правки | **Cursor** | Очень быстрые IDE‑итерации и локальные изменения |
| Разобраться в чужом проекте, найти нужные места, объяснить поток данных | **Claude Code** | Хорош для анализа кодовой базы и сложных связей |
| Большой рефактор (переезды модулей, массовые правки, снижение техдолга) | **Claude Code** + **Cursor** | Claude — план/многофайловая логика, Cursor — точечная доводка |
| Реализация backend‑фичи «под тесты»: эндпоинты, сервис‑слой, миграции | **Codex CLI** + **Claude Code** | Codex — делает изменения и прогоняет команды, Claude — архитектура/ревью |
| Дебаг по логам/стектрейсам с обращением к докам и типовым ошибкам | **Gemini CLI** + (Claude/Codex) | Gemini — внешний контекст, остальные — фикс и верификация |
| PR review, triage issues, помощь в GitHub Actions | **Gemini CLI** | Удобен для triage/review и интеграций |
| «Привести проект в порядок»: форматирование, линтеры, мелкие исправления | **Claude Code** или **Codex CLI** | Терминальные прогоны + авто‑фикс |

---

## 4) Рекомендованное разделение по слоям

### 4.1. Backend (API / DB / интеграции)
- **Архитектура и план**: Claude Code
- **Имплементация с проверками**: Codex CLI
- **Поиск по внешним докам/SDK/ошибкам**: Gemini CLI

### 4.2. Frontend (UI / UX / состояния)
- **Основная работа**: Cursor
- **Крупные фронтовые рефакторы**: Claude Code (план) → Cursor (исполнение)
- **Сложные баги сборки/рантайма**: Gemini CLI (поиск) + Codex/Claude (фикс)

---

## 5) Практичный мультиагентный пайплайн (шаблон)

1. **Архитектор (Claude Code)**
- «Прочитай код, предложи 2–3 варианта, выбери один, дай план и список файлов»

2. **Исполнитель (Codex CLI)**
- «Сделай шаги 1–3 из плана, запусти `…`, покажи вывод, держи дифф маленьким»

3. **UI‑доводка (Cursor)**
- «Подчисти UX/компоненты/типизацию, сделай аккуратный дифф, проверь вручную»

4. **Ревьюер (Gemini CLI или отдельный Claude)**
- «Найди риски, проверь edge cases, предложи тест‑кейсы, проверь безопасность»

5. **Финал**
- «Один прогон всех проверок + PR‑описание + миграционные шаги»

---

## 6) Мини‑шаблон `AGENTS.md` (скелет)

Вставить в репозиторий и дополнять:
- Стек, версии, менеджер пакетов
- Конвенции: форматирование, архитектура, именование
- Команды проверки: `lint`, `test`, `typecheck`, `build`
- Правила диффа: маленькие изменения, не менять несвязанные файлы
- Запреты: не трогать секреты, не добавлять зависимости без причины
- Стиль PR: описание, чек‑лист, инструкции по миграциям

---

## 7) Быстрые «анти‑паттерны» вайбкодинга

- «Сделай всё сразу» → огромный дифф без проверок
- «Думай и кодь в одном потоке» → нет роли ревьюера
- «Скажи что протестировал» без логов → ложная уверенность
- «Меняй архитектуру по ходу» без ADR → хаос
- «Пофикси линтер в конце» → много мелких конфликтов

---

## 8) Что стоит сделать прямо сейчас

1. Добавить `SPEC.md` / `ADR.md` шаблон
2. Добавить `AGENTS.md` / `GEMINI.md` с правилами проекта
3. Включить CI: lint + test + typecheck + build
4. Принять правило: 1 фича = серия маленьких PR/коммитов
5. Ввести роль ревьюера (пусть даже это второй агент)
