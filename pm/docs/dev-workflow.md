# Dev workflow (vibe-coding) — Multi-agent + limits + fallback

Этот документ описывает **рабочий протокол** для командной разработки с помощью нескольких агентов (Codex CLI, Claude Code, Gemini CLI, Cursor) и OpenClaw.

Reference/чеклист best practices вынесен отдельно:
- `pm/docs/vibecoding-best-practices.md`

Цель: **маленькие диффы, воспроизводимые проверки, минимум хаоса**.

---

## 1) Базовый протокол мультиагентной разработки

### 1.1 Всегда начинать с короткого контракта (1–2 страницы)
Артефакт: `SPEC.md` или `ADR.md` + чек‑лист **Definition of Done**.

Включить:
- цель фичи и не‑цели
- публичные интерфейсы (API/props), форматы ошибок
- edge cases
- как проверяем (команды тестов/линтеров/сборки)
- риски: секреты, миграции, безопасность, обратная совместимость

### 1.2 Резать задачу на тонкие «слайсы»
Агенты лучше всего работают, когда:
- дифф маленький
- есть чёткая команда проверки
- есть стоп‑пойнты: «после каждого шага покажи что изменил и как проверил»

### 1.3 Принудительное разделение ролей
Минимальный набор ролей:
- **Архитектор/планировщик**: предлагает варианты, выбирает подход, пишет план
- **Исполнитель**: вносит изменения в код
- **Ревьюер/QA**: ищет баги/риски, проверяет тест‑кейсы, стиль, безопасность
- (опционально) **Документатор**: README, миграционные заметки, changelog

Не смешивать роли в одном потоке: иначе растёт вероятность ошибок и «подгонки» под ответ.

### 1.4 Цикл «План → Код → Проверка» обязателен
Универсальная формула промпта:
1. «Сначала предложи план из 5–10 шагов»
2. «Пиши код строго по шагам, маленькими порциями»
3. «После каждого шага: что изменил + как проверил»
4. «Если не можешь проверить — скажи, что нужно для проверки»

### 1.5 Память проекта хранить в репозитории
Список файлов, которые держат конвенции и правила:
- `pm/docs/dev-workflow.md` (этот документ)
- `GEMINI.md` (инструкции для Gemini)
- `CONTRIBUTING.md` / `ARCHITECTURE.md` (если появятся)

### 1.6 Безопасность: минимальные права + песочница
- не давать агентам доступ к секретам по умолчанию
- держать секреты вне репо (см. `PM_SECRETS_ROOT`)
- включить CI как «источник правды»

---

## 2) Инструменты: кому что назначать

Быстрое правило:
- **Cursor** — IDE‑first «ручной штурвал»: фронт, UI, точечные правки, быстрые итерации.
- **Claude Code** — «тяжёлая инженерка»: анализ большой кодовой базы, дебаг, тесты.
- **Codex CLI** — «воспроизводимая агентность»: чёткие шаги + команды проверки + аккуратный цикл.
- **Gemini CLI** — «архитектура/поиск/триаж/ревью»: внешний контекст, интеграции, обзор больших изменений.

---

## 3) Лимиты и fallback (Plus/Pro)

У Codex/Claude на подписках лимиты чаще всего **по числу запросов/сообщений в окно**.
Поэтому главная оптимизация:
- меньше turns → один большой запрос → локальные команды → один ответ

### 3.1 Правила для исполнителей
- 1 активный «исполнитель» (codex/claude) одновременно
- отдельный git worktree на задачу
- обязательные проверки: `npm test` (и фикс, если упало)

### 3.2 Fallback
Если provider упёрся в лимит:
- ставим cooldown
- переключаемся на другой provider

Реализовано через `tools/agent-runner.mjs`.

---

## 4) Практичный пайплайн (шаблон)

1) **Архитектор (Gemini/Claude)**
- читает код, предлагает варианты
- фиксирует контракт (`SPEC.md`/`ADR.md`)

2) **Исполнитель (Codex/Claude Code)**
- делает реализацию маленькими шагами
- запускает проверки
- делает коммиты

3) **Ревьюер (Gemini или отдельный Claude)**
- ищет риски, edge cases
- предлагает тест-кейсы

4) **Финал**
- один полный прогон проверок
- PR описание + шаги проверки

---

## 5) Как запускать через OpenClaw

Используем `tools/agent-runner.mjs`:
- он сам создаёт git worktree под задачу
- выбирает provider с fallback: codex → claude → gemini
- ставит cooldown при rate-limit

Примеры:
```bash
node tools/agent-runner.mjs --task "Auth backend: cookie sessions + PM_SECRETS_ROOT" \
  --branch feat/auth-cookie --base main

node tools/agent-runner.mjs --task "Web UI: /login + AuthProvider" \
  --branch feat/web-login --base main

node tools/agent-runner.mjs --task "Review security of auth cookies" \
  --mode review --provider gemini --no-worktree
```

---

## 6) Анти‑паттерны
- «Сделай всё сразу» → огромный дифф без проверок
- «Думай и кодь в одном потоке» → нет независимого ревью
- «Скажи что протестировал» без логов → ложная уверенность
- «Меняй архитектуру по ходу» без ADR → хаос

