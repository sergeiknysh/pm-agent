---
id: TASK-0006
title: "Telegram команды: /add /today /inbox /done (через Vexta) — дизайн и реализация"
status: doing
project: vextaibot
priority: P1
tags: [telegram, pm]
created: 2026-01-30T23:32:54.278Z
updated: 2026-01-31T01:14:10+01:00
estimate: 6h
---

## Цель
Сделать минимальный, быстрый UX в Telegram для ведения PM-as-Files:
- добавить мысль/задачу во входящие
- посмотреть «что сегодня»
- посмотреть inbox
- быстро отметить задачу выполненной

Реализация предполагается **внутри OpenClaw-агента** (парсинг команд в Telegram) с записью в markdown-файлы как единственный source of truth.

## Область (MVP)
Команды:
- `/add <text>`
- `/inbox` (последние N элементов)
- `/today`
- `/done <id|n>`

Сценарии ввода:
- Команда может быть отправлена как отдельное сообщение.
- `/add` и `/done` должны работать также, если команда отправлена **reply** на сообщение (тогда берём текст из replied-to сообщения, если аргумент пустой).

## UX / Поведение команд

### `/add <text>`
**Назначение:** быстро закинуть во входящие, без выбора проекта.

**Ввод:**
- `/add купить батарейки`
- reply: пользователь отвечает на любое сообщение командой `/add` (без аргумента) — используется текст оригинального сообщения.

**Запись:**
- append в `pm/inbox.md` новой строкой.
- формат строки (предложение):
  - `- [ ] <text>  \n  - meta: created=<iso>, src=telegram, chat=<id>, msg=<id>`
  - или одной строкой: `- [ ] <text> (tg:<chatId>/<msgId>, 2026-01-30)`

**Ответ бота:**
- краткий ack: `Добавлено во входящие: “…”`
- желательно включить inline-кнопки (см. TASK-0007) только если удаётся создать task-файл сразу. Для MVP достаточно inbox-append без кнопок.

**Ошибки:**
- если нет текста и не reply: показать подсказку `Использование: /add <текст> или ответьте /add на сообщение`.


### `/inbox`
**Назначение:** показать последние элементы `pm/inbox.md` для triage.

**Поведение:**
- показать последние N (по умолчанию 10–20) `- [ ]` элементов из `pm/inbox.md`.
- если файл пуст — `Inbox пуст`.

**Ответ бота:**
- список пунктов, пронумерованный `1) …`.
- сохранить контекст “последний список” для последующих команд (см. «Контекст выбора по номеру»).


### `/today`
**Назначение:** быстро увидеть «что сделать сегодня».

**Критерии отбора (MVP):**
- задачи (task-файлы) со `status != done` и:
  - `due == today` **или** `due < today` (просрочено)
- опционально (в отдельном блоке): `status == doing` вне зависимости от due.

**Источник данных:**
- `pm/_meta/index.json` (если уже есть генератор) или прямой обход `pm/projects/*/tasks/*.md`.

**Ответ бота:**
- секции:
  - `Просрочено:`
  - `Сегодня:`
  - `Doing:`
- каждая строка: `- TASK-0007 — Title (P1, project)`.
- сохранить контекст “последний список” (мэппинг номер→id) для `/done 2` и т.п.


### `/done <id|n>`
**Назначение:** отметить задачу выполненной.

**Ввод:**
- `/done TASK-0007`
- `/done 2` — номер из последнего `/today` или `/inbox` списка (если применимо)
- reply: пользователь отвечает `/done` на сообщение бота, где есть `TASK-XXXX` — достать id из текста.

**Поведение:**
- если указан TASK-id: обновить task-файл: `status: done`, `updated: now`.
- если указан номер: взять id из сохранённого контекста “последний список”.

**Ответ бота:**
- `Готово: TASK-0007 — Title`

**Ошибки:**
- неизвестный id / номер вне диапазона: показать понятную ошибку + hint.

## Контекст выбора по номеру (важно для UX)
Для `/done 2` (и будущих `/doing 2`, `/todo 2`) нужен state.

Рекомендация (без БД): хранить маленький json-файл:
- `pm/_meta/telegram-context.json`

Структура (предложение):
```json
{
  "byChat": {
    "<chatId>": {
      "lastList": {
        "created": "2026-01-30T23:50:00Z",
        "items": ["TASK-0007", "TASK-0006"],
        "source": "today"
      }
    }
  }
}
```
TTL: 24h (или до перезаписи).

## Реализация в OpenClaw
Подход: **парсинг Telegram-сообщений на уровне агента**.

### Маршрутизация
- Если входящее сообщение начинается с `/add`, `/inbox`, `/today`, `/done` — обрабатываем как “команда PM”.
- Иначе — обычный чат.

### Операции над файлами
- `/add` → append к `pm/inbox.md`.
- `/today`/`/inbox` → чтение + форматирование вывода.
- `/done` → правка YAML frontmatter в нужном task-файле.

Примечание: для правки frontmatter используем максимально “surgical” edit:
- читать файл
- парсить YAML между `---`
- обновить `status` и `updated`
- записать назад

## Нефункциональные требования
- Быстро (ответ < 1–2 сек при небольшом количестве задач).
- Без внешней БД.
- Идемпотентность `/done` (повтор не ломает).

## Чеклист
- [ ] Уточнить финальный формат строки для `pm/inbox.md` (однострочный vs meta-блок)
- [ ] Спека парсинга команд: аргументы + reply-behavior
- [ ] Реализовать `/add` → append в inbox
- [ ] Реализовать `/inbox` → tail N + сохранить lastList
- [ ] Реализовать `/today` → выборка due<=today + сохранить lastList
- [ ] Реализовать `/done` по id / по номеру / по reply
- [ ] Добавить `pm/_meta/telegram-context.json` в .gitignore? (скорее **нет**, лучше коммитить? обсудить)
- [ ] Тест-кейсы (ручные): пустой inbox, /add без текста, /done 999, /done TASK-xxxx

## Связано
- TASK-0005: генерация `pm/_meta/index.json`
- TASK-0007: inline buttons для статусов/сноза

## Лог
- 2026-01-30T23:32:54.278Z: создано планом
- 2026-01-31T01:14:10+01:00: старт реализации Telegram команд
- 2026-01-30T23:59:00.000Z: добавлена спецификация UX и реализации
